<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marvel vs DC — Distribuição por Estados (Mapa 2024)</title>
  <!-- Versões compatíveis -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4.3.1"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    h2 { text-align: center; margin-bottom: 20px; }
    .chart-box {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 1000px;
      margin: auto;
    }
    #custom-tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h2>Marvel vs DC — Distribuição por Estados (Mapa 2024)</h2>
  <div class="chart-box">
    <canvas id="mapChart"></canvas>
  </div>
  <div id="custom-tooltip"></div>

  <script>
    // Registro explícito dos componentes do plugin
    const { ChoroplethController, Choropleth, GeoFeature } = ChartGeo;
    Chart.register(ChoroplethController, Choropleth, GeoFeature);

    // Dataset Marvel/DC (nomes com acento)
    const dataEstados = {
      "Acre": [30,70], "Alagoas": [33,67], "Amapá": [28,72], "Amazonas": [29,71],
      "Bahia": [26,74], "Ceará": [30,70], "Distrito Federal": [26,74], "Espírito Santo": [29,71],
      "Goiás": [28,72], "Maranhão": [27,73], "Mato Grosso": [31,69], "Mato Grosso do Sul": [30,70],
      "Minas Gerais": [24,76], "Pará": [26,74], "Paraíba": [31,69], "Paraná": [27,73],
      "Pernambuco": [26,74], "Piauí": [33,67], "Rio de Janeiro": [27,73], "Rio Grande do Norte": [31,69],
      "Rio Grande do Sul": [28,72], "Rondônia": [30,70], "Roraima": [26,74], "Santa Catarina": [26,74],
      "São Paulo": [25,75], "Sergipe": [33,67], "Tocantins": [29,71]
    };

    // Normalização de nomes: remove acentos e baixa tudo
    function normalize(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Índice de lookup normalizado para o dataset
    const dataLookup = {};
    Object.keys(dataEstados).forEach(nome => {
      dataLookup[normalize(nome)] = { nome, dc: dataEstados[nome][0], marvel: dataEstados[nome][1] };
    });

    // Escala de cor: vermelho se Marvel > DC, azul se DC > Marvel
    function getColor(dc, marvel) {
      if (marvel > dc) {
        const intensidade = (marvel - dc) / 100;
        return `rgba(230,57,70,${0.3 + intensidade*0.7})`;
      } else {
        const intensidade = (dc - marvel) / 100;
        return `rgba(0,123,255,${0.3 + intensidade*0.7})`;
      }
    }

    // Carrega GeoJSON (estados brasileiros)
    fetch("https://raw.githubusercontent.com/fititnt/gis-dataset-brasil/master/geojson/estados.json")
      .then(res => res.json())
      .then(geo => {
        // Monta dataset com match de nomes via normalização
        const features = geo.features.map(f => {
          const nomeGeo = f.properties.NOME;            // nomes sem acento no arquivo
          const key = normalize(nomeGeo);               // normaliza
          const found = dataLookup[key];                // procura no dataset normalizado
          const nomeFinal = found ? found.nome : nomeGeo;
          const dc = found ? found.dc : 0;
          const marvel = found ? found.marvel : 0;
          return {
            feature: f,
            value: marvel - dc,
            dc, marvel, nome: nomeFinal
          };
        });

        const ctx = document.getElementById("mapChart").getContext("2d");
        new Chart(ctx, {
          type: "choropleth",
          data: {
            labels: features.map(f => f.nome),
            datasets: [{
              label: "Distribuição por Estados",
              outline: { type: 'FeatureCollection', features: geo.features },
              data: features.map(f => ({
                feature: f.feature,
                value: f.value,
                dc: f.dc,
                marvel: f.marvel,
                nome: f.nome
              })),
              backgroundColor: c => {
                const d = c.raw;
                return getColor(d.dc, d.marvel);
              },
              borderColor: 'rgba(0,0,0,0.15)',
              borderWidth: 0.5
            }]
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: false, // tooltip externo
                external: function(context) {
                  const tooltipEl = document.getElementById('custom-tooltip');
                  const tooltipModel = context.tooltip;
                  if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                  }
                  const d = tooltipModel.dataPoints[0].raw;
                  const state = d.nome;
                  const dc = d.dc;
                  const marvel = d.marvel;

                  tooltipEl.innerHTML = `
                    <div style="font-weight:600;margin-bottom:6px;">${state}</div>
                    <div style="display:flex;align-items:center;gap:12px;">
                      <div>
                        <div style="display:flex;justify-content:space-between;gap:12px;">
                          <span style="color:#007bff;">DC Comics</span>
                          <span style="color:#007bff;">${dc}%</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;gap:12px;">
                          <span style="color:#e63946;">Marvel Comics</span>
                          <span style="color:#e63946;">${marvel}%</span>
                        </div>
                      </div>
                      <canvas id="miniChart" width="64" height="64"></canvas>
                    </div>
                    <div style="margin-top:8px;font-size:12px;color:#555;">
                      Porcentagens calculadas das pesquisas para todos os 2 termos em ${state}
                    </div>
                  `;

                  // Posiciona perto do cursor
                  const rect = context.chart.canvas.getBoundingClientRect();
                  tooltipEl.style.left = rect.left + context.chart._lastEvent.x + 15 + "px";
                  tooltipEl.style.top = rect.top + context.chart._lastEvent.y + 15 + "px";
                  tooltipEl.style.opacity = 1;

                  const miniCtx = document.getElementById("miniChart").getContext("2d");
                  if (miniCtx._chartInstance) miniCtx._chartInstance.destroy();
                  miniCtx._chartInstance = new Chart(miniCtx, {
                    type: "doughnut",
                    data: {
                      labels: ["DC","Marvel"],
                      datasets: [{
                        data: [dc, marvel],
                        backgroundColor: ["#007bff","#e63946"]
                      }]
                    },
                    options: {
                      plugins:{legend:{display:false}},
                      cutout:"60%",
                      responsive:false
                    }
                  });
                }
              }
            },
            scales: {
              projection: {
                // Projeção adequada para mapas no plugin
                axis: 'xy',
                projection: 'equalEarth'
              }
            }
          }
        });
      });
  </script>
</body>
</html>
